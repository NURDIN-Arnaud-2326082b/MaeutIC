{% if is_granted('IS_AUTHENTICATED_FULLY') and form is defined %}
<div id="post-create-modal" class="fixed inset-0 w-full h-full bg-black bg-opacity-50 flex justify-center items-center z-[1000] hidden">
    <div class="bg-white/95 text-gray-700 p-5 rounded-lg w-[90%] max-w-[500px] shadow-lg relative">
        <span class="absolute top-2 right-2 text-2xl cursor-pointer" onclick="closePostCreateModal()">&times;</span>
        <h2 class="text-xl font-bold mb-4">Cr√©er une publication</h2>

        <div class="form-container">
            {# Conteneur pour les alertes de pr√©vention #}
            <div id="prevention-alerts" class="space-y-2 mb-4 max-h-40 overflow-y-auto"></div>

            {{ form_start(form, {
                'attr': {'id': 'post-create-form'},
                'action': path('app_post_add', { category: category })
            }) }}
                <div class="mb-4">
                    {{ form_label(form.name) }}
                    {{ form_widget(form.name, {'attr': {'class': 'bg-white mt-1 block w-full border border-gray-300 rounded-md p-2', 'multiple': false, 'id': 'post-title'}}) }}
                    <span class="text-red-500">{{ form_errors(form.name) }}</span>
                </div>

                <div class="mb-4">
                    {{ form_label(form.description) }}
                    {{ form_widget(form.description, {'attr': {'class': 'bg-white mt-1 block w-full border border-gray-300 rounded-md p-2', 'multiple': false, 'id': 'post-description'}}) }}
                    <span class="text-red-500">{{ form_errors(form.description) }}</span>
                </div>

                <div class="mb-4">
                    {{ form_label(form.forum) }}
                    {{ form_widget(form.forum, {'attr': {'class': 'bg-white mt-1 block w-full border border-gray-300 rounded-md p-2', 'multiple': false}}) }}
                    <span class="text-red-500">{{ form_errors(form.forum) }}</span>
                </div>

                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Publier</button>
            {{ form_end(form) }}
        </div>
    </div>
</div>

<style>

.form-container {
    max-height: 90vh;
    overflow-y: auto;
    padding-right: 8px; /* Pour √©viter que le contenu soit cach√© derri√®re la scrollbar */
}
.form-container::-webkit-scrollbar {
    width: 8px;
}
.form-container::-webkit-scrollbar-thumb {
    background-color: rgba(100, 100, 100, 0.5);
    border-radius: 4px;
}
.form-container::-webkit-scrollbar-track {
    background-color: rgba(200, 200, 200, 0.2);
    border-radius: 4px;
}
</style>

<script>
    function openPostCreateModal() {
        document.getElementById('post-create-modal').classList.remove('hidden');
        setTimeout(setupContentMonitoring, 200);
    }
    
    function closePostCreateModal() {
        document.getElementById('post-create-modal').classList.add('hidden');
        const alertsContainer = document.getElementById('prevention-alerts');
        if (alertsContainer) {
            alertsContainer.innerHTML = '';
        }
    }

    function setupContentMonitoring() {
        const descriptionInput = document.getElementById('post-description');
        const titleInput = document.getElementById('post-title');
        const alertsContainer = document.getElementById('prevention-alerts');
        
        let descInput = descriptionInput;
        let titInput = titleInput;
        
        // Recherche alternative si les IDs directs ne fonctionnent pas
        if (!descInput) {
            descInput = document.querySelector('[name*="description"], textarea');
        }
        
        if (!titInput) {
            titInput = document.querySelector('[name*="name"], input[type="text"]');
        }
        
        if (!descInput || !alertsContainer) {
            return; // √âl√©ments essentiels manquants
        }
        
        const warningPatterns = {
            suicide: {
                keywords: [
                    'suicide', 'suicidaire', 'me tuer', 'en finir', 'mort', 'mourir', 'je veux mourir', 
                    'plus envie de vivre', 'vie ne vaut plus la peine', 'suicider', 'passage √† l\'acte',
                    'id√©es noires', 'pens√©es suicidaires', 'envie de dispara√Ætre', 'fini ma vie',
                    'plus la force', 'veux en finir', 'd√©sesp√©r√©', 'd√©sespoir total', 'souhaite mourir',
                    'pr√©f√©rerais √™tre mort', '√ßa sert √† rien', 'plus d\'espoir', 'sans issue',
                    'solution finale', 'd√©fenestration', 'pendaison', 'overdose volontaire',
                    'crise suicidaire', 'geste ultime', 'abandonner la vie', 'l√¢cher prise',
                    'fatigue de vivre', '√©puisement vital', 'ras-le-bol g√©n√©ral', 'burn out total',
                    'cry √† l\'aide', 'plus go√ªt √† rien', 'vide existentiel', 'n√©ant',
                    'suicidologie', 'automutilation', 'scarification', 'blessures volontaires',
                    'tentative suicide', 'TS', 'id√©e suicidaire', 'projet suicide', 'plan suicide',
                    'lettre d\'adieu', 'testament', 'don d\'organes', 'pr√©paratifs fun√©raires',
                    'au revoir', 'dernier message', 'cry de d√©tresse', 'd√©tresse aigu√´',
                    'urgence vitale', 'risque imm√©diat', 'danger imminent', 'point de non-retour',
                    'abandon', 'renoncement', 'capitulation', 'd√©faite', '√©chec total',
                    'honte insurmontable', 'culpabilit√© √©crasante', 'remords', 'regrets',
                    'solitude extr√™me', 'isolement total', 'rejet massif', 'incompr√©hension',
                    'maladie incurable', 'douleur chronique', 'handicap lourd', 'diagnostic fatal',
                    'faillite', 'ruine', 'endettement', 'expulsion', 'sans-abri', 'pr√©carit√© extr√™me'
                ],
                message: 'üíô Besoin d\'aide ? Appelez le 3114 - Service national de pr√©vention du suicide. Des professionnels sont l√† pour vous √©couter 24h/24.',
                link: 'https://www.suicide-ecoute.fr/'
            },
            depression: {
                keywords: [
                    'd√©prim√©', 'd√©pression', 'tristesse', 'd√©sespoir', 'vide', 'solitude', 'isolement', 
                    'plus d\'√©nergie', 'cafard', 'mal √™tre', 'blues', 'm√©lancolie', 'd√©prime', 'coup de mou',
                    'baisse de moral', 'humeur d√©pressive', 'perte d\'int√©r√™t', 'anh√©donie', 'apathie',
                    'l√©thargie', 'fatigue chronique', 'insomnie', 'hypersomnie', 'perte d\'app√©tit',
                    'crise existentielle', 'mal de vivre', 'd√©tresse psychologique', 'd√©sarroi',
                    'abattement', 'accablement', 'd√©couragement', 'd√©moralisation', 'perte d\'estime',
                    'culpabilit√©', 'honte', 'sentiment d\'√©chec', 'impuissance', 'd√©sillusion',
                    'crise de nerfs', 'd√©compensation', '√©puisement nerveux', 'surmenage',
                    'bore out', 'burn out', 'effondrement', 'crise de larmes',
                    'd√©pression majeure', 'trouble d√©pressif', '√©pisode d√©pressif', 'dysthymie',
                    'd√©pression saisonni√®re', 'd√©pression post-partum', 'baby blues s√©v√®re',
                    'deuil compliqu√©', 'deuil pathologique', 'perte insurmontable', 'deuil impossible',
                    'chagrin d\'amour', 'rupture douloureuse', 'trahison', 'abandon affectif',
                    'nostalgie', 'regret du pass√©', 'rumination', 'pens√©es obsessionnelles',
                    'auto-d√©pr√©ciation', 'd√©nigrement de soi', 'critique interne', 'juge int√©rieur',
                    'incapacit√© √† aimer', 'incapacit√© √† ressentir', '√©motions plates', 'affect aplati',
                    'ralentissement psychomoteur', 'difficult√© concentration', 'trouble m√©moire',
                    'ind√©cision', 'incapacit√© choisir', 'paralysie d√©cisionnelle', '√©vitement',
                    'repli sur soi', 'isolement social', 'phobie sociale', '√©vitement relationnel',
                    'perte libido', 'trouble sexuel', 'd√©sint√©r√™t relation', 'conflit conjugal',
                    '√©chec professionnel', 'ch√¥mage longue dur√©e', 'reconversion difficile'
                ],
                message: 'üíö Vous traversez une p√©riode difficile ? Contactez SOS Amiti√© au 09 72 39 40 50. Parler peut vous aider.',
                link: 'https://www.sos-amitie.com/'
            },
            harassment: {
                keywords: [
                    'harc√®lement', 'harc√®le', 'intimidation', 'menace', 'cyberharc√®lement', 'moquerie', 
                    'humiliation', 'pers√©cution', 'bullying', 'brimade', 'maltraitance', 'abus de pouvoir',
                    'chantage', 'chantage affectif', 'manipulation', 'emprise', 'emprise mentale',
                    'stalking', 'harc√®lement moral', 'harc√®lement sexuel', 'harc√®lement scolaire',
                    'harc√®lement professionnel', 'harc√®lement t√©l√©phonique', 'cyberintimidation',
                    'revenge porn', 'diffamation', 'calomnie', 'm√©disance', 'ragots', 'rumeurs',
                    'mise √† l\'√©cart', 'ostracisme', 'rejet', 'exclusion', 'discrimination',
                    'sexisme', 'racisme', 'homophobie', 'transphobie', 'discrimination handicap',
                    'agression verbale', 'insulte', 'injures', 'menaces de mort', 'chantage au suicide',
                    'harc√®lement de rue', 'harc√®lement transports', 'harc√®lement num√©rique',
                    'doxing', 'usurpation identit√©', 'faux profil', 'piratage compte',
                    'chantage sexuel', 'sextorsion', 'photo intime', 'vid√©o compromettante',
                    'mobbing', 'harc√®lement institutionnel', 'harc√®lement administratif',
                    'discrimination syst√©mique', 'pr√©jug√©s', 'st√©r√©otypes', 'micro-agressions',
                    'gaslighting', 'manipulation psychologique', 'contr√¥le coercitif',
                    'violence √©conomique', 'privation ressources', 'contr√¥le financier',
                    'isolement social', 'coupure familiale', 'ali√©nation parentale',
                    'harc√®lement proc√©durier', 'poursuite abusive', 'proc√©dure harassante',
                    'repr√©sailles', 'vengeance', 'campagne diffamatoire', 'd√©nigrement public',
                    'atteinte r√©putation', 'honte publique', 'humiliation collective'
                ],
                message: 'üõ°Ô∏è Victime de harc√®lement ? Appelez le 3020 (harc√®lement scolaire), le 3018 (cyberharc√®lement) ou le 3919 (violences femmes). Vous n\'√™tes pas seul(e).',
                link: 'https://www.education.gouv.fr/non-au-harcelement'
            },
            violence: {
                keywords: [
                    'violence', 'violent', 'agress', 'battre', 'frapper', 'abus', 'maltraitance', 
                    'coups', 'brimade', 'agression', 'violence conjugale', 'violence domestique',
                    'violence psychologique', 'violence verbale', 'violence physique', 'violence sexuelle',
                    'viol', 'agression sexuelle', 'attouchements', 'inceste', 'p√©dophilie',
                    'mariage forc√©', 'mutilation g√©nitale', 'crime d\'honneur', 'f√©micide',
                    'conjoint violent', 'partenaire violent', 'tyran domestique', 'bourreau',
                    's√©vices', 'torture', 's√©questration', 'privation de libert√©', 'enl√®vement',
                    'arme blanche', 'arme √† feu', 'couteau', 'revolver', 'passage √† tabac',
                    'lynchage', 'bastonnade', 'violence polici√®re', 'brutalit√©', 'barbarie',
                    'cruaut√©', 'sadisme', 'traitement inhumain',
                    'violence √©conomique', 'contr√¥le financier', 'privation argent', 'dette forc√©e',
                    'violence administrative', 'menace expulsion', 'chantage administratif',
                    'violence gyn√©cologique', 'obst√©trique violente', 'accouchement traumatique',
                    'violence obst√©tricale', 'm√©dicalisation forc√©e', 'traitement impos√©',
                    'maltraitance infantile', 'enfant battu', 'n√©gligence enfant', 'carence soins',
                    'violence √©ducative', 'punition corporelle', 'fess√©e', 'gifle √©ducative',
                    'violence symbolique', 'm√©pris de classe', 'discrimination sociale',
                    'violence linguistique', 'interdiction langue', 'humiliation culturelle',
                    'traite √™tres humains', 'esclavage moderne', 'travail forc√©', 'exploitation',
                    'mutilation', 'blessure volontaire', 'marquage', 'tatouage forc√©',
                    'prison domestique', 'confinement', 'interdiction sortir', 'contr√¥le d√©placements'
                ],
                message: 'üõ°Ô∏è En cas de violence, appelez le 3919 (Violences Femmes Info) ou le 119 (Enfance en danger). Des aides existent.',
                link: 'https://arretonslesviolences.gouv.fr/'
            },
            addiction: {
                keywords: [
                    'drogue', 'alcool', 'addiction', 'd√©pendance', 'sevrage', 'overdose', 'ivre', 
                    'saoul', 'd√©chet', 'cuite', 'cannabis', 'h√©ro√Øne', 'coca√Øne', 'tabac', 'jeu', 
                    'jeux d\'argent', 'substance', 'psychotrope', 'stup√©fiant', 'drogage',
                    'toxicomanie', 'alcoolisme', '√©thylisme', 'binge drinking', 'biture express',
                    'd√©fonce', 'trip', 'bad trip', 'manque', 'craving', 'rechute', 'd√©sintoxication',
                    'sevrage brutal', 'delirium tremens', 'overdose', 'OD', 'shoot', 'injection',
                    'sniff', 'fumer', 'joint', 'pipe √† crack', 'paraphernalie', 'dopage',
                    'm√©dicament d√©tourn√©', 'benzodiaz√©pine', 'opiac√©', 'amph√©tamine', 'ecstasy',
                    'LSD', 'champignons', 'addiction sexuelle', 'addiction affective', 'addiction au travail',
                    'addiction aux √©crans', 'nomophobie', 'cyberd√©pendance', 'addiction aux jeux vid√©o',
                    'paris sportifs', 'poker', 'casino', 'machines √† sous', 'endettement jeu', 'addict',
                    'crystal meth', 'methamph√©tamine', 'crack', 'opio√Øde', 'morphine', 'fentanyl',
                    'tramadol', 'cod√©ine', 'bupr√©norphine', 'm√©thadone', 'subutex', 'suboxone',
                    'ghb', 'k√©tamine', 'poppers', 'solvants', 'colle', '√©ther', 'protoxyde azote',
                    'ballon', 'gaz hilarant', 'nitrite amyl', 'ritaline', 'concerta', 'adderall',
                    'modafinil', 'steroides', 'hormones', 'dopage sportif', 'compl√©ment alimentaire',
                    'plante psychoactive', 'salvia', 'kratom', 'ayahuasca', 'mescaline', 'peyotl',
                    'd√©pendance affective', 'relation toxique', 'cod√©pendance', 'attachement anxieux',
                    'addiction relationnelle', 'besoin fusionnel', 'peur abandon', 'jalousie maladive',
                    'addiction travail', 'workaholisme', 'surinvestissement professionnel',
                    'addiction sport', 'bigorexie', 'dysmorphie musculaire', 'exercice compulsif',
                    'addiction achats', 'oniomanie', 'd√©pense compulsive', 'carte cr√©dit',
                    'd√©pendance m√©dicamenteuse', 'iatrog√®ne', 'm√©dicament addiction'
                ],
                message: 'üß† Besoin d\'aide pour une addiction ? Appelez Drogues Info Service au 0 800 23 13 13 (appel gratuit), Alcool Info Service au 09 80 98 09 30, ou Joueurs Info Service au 09 74 75 13 13 (jeu d\'argent).',
                link: 'https://www.drogues-info-service.fr/'
            },
            eating_disorder: {
                keywords: [
                    'anorexie', 'boulimie', 'tca', 'trouble alimentaire', 'je me prive de manger', 
                    'crise de boulimie', 'hyperphagie', 'orthorexie', 'm√©rycisme', 'pica',
                    'restriction alimentaire', 'je√ªne', 'di√®te', 'r√©gime strict', 'calories',
                    'compter les calories', 'peur de grossir', 'dysmorphophobie', 'image corporelle',
                    'vomissements provoqu√©s', 'laxatifs', 'diur√©tiques', 'crise de compulsion',
                    'grignotage pathologique', 'fringales', 'honte alimentaire', 'culpabilit√© repas',
                    'pes√©e obsessionnelle', 'mirror checking', '√©vitement social repas',
                    'rituels alimentaires', 'aliments interdits', 'aliments safe', 'body checking',
                    'd√©nutrition', 'amaigrissement', 'perte de poids rapide', 'IMC bas',
                    'am√©norrh√©e', 'perte r√®gles', 'trouble hormonal', 'carences nutritionnelles',
                    'anorexie mentale', 'boulimie nerveuse', 'hyperphagie boulimique',
                    'trouble alimentaire nocturne', 'syndrome d\'alimentation nocturne',
                    'phagophobie', 'peur avaler', 'trouble s√©lectif', 'ARFID', 'alimentation √©vitante',
                    'n√©ophobie alimentaire', 'peur nouveaux aliments', 'r√©gime monotone',
                    'comportement compensatoire', 'exercice excessif', 'sport compulsif',
                    'je√ªne intermittent extr√™me', 'd√©tox abusive', 'r√©gime hypocalorique',
                    'calcul obsessionnel', 'application calories', 'tracking alimentaire',
                    'comparaison corps', 'complexe physique', 'd√©go√ªt corps', 'honte corporelle',
                    'dysmorphie corporelle', 'obsession musculaire', 'muscle dysmorphia',
                    'trouble image corporelle', 'perception d√©form√©e', 'miroir d√©formant',
                    '√©vitement miroir', 'photoshop corps', 'filtre apparence', 'retouche photo'
                ],
                message: 'üçé Besoin d\'aide pour un trouble alimentaire ? Contactez Fil Sant√© Jeunes au 0 800 235 236.',
                link: 'https://www.filsantejeunes.com/'
            }
        };
        
        function checkSensitiveContent(text) {
            if (!text || text.trim().length === 0) return [];
            
            const detectedWarnings = [];
            
            // Fonction pour normaliser le texte (supprimer les accents)
            const normalizeText = (str) => {
                return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            };
            
            const normalizedText = normalizeText(text);
            
            for (const [category, pattern] of Object.entries(warningPatterns)) {
                const hasMatch = pattern.keywords.some(keyword => {
                    const normalizedKeyword = normalizeText(keyword);
                    return normalizedText.includes(normalizedKeyword);
                });
                
                if (hasMatch && !detectedWarnings.some(w => w.message === pattern.message)) {
                    detectedWarnings.push(pattern);
                }
            }
            
            return detectedWarnings;
        }
        
        function displayAlerts(warnings) {
            alertsContainer.innerHTML = '';
            
            if (warnings.length === 0) {
                return;
            }
            
            // Animation d'apparition
            alertsContainer.style.opacity = '0';
            alertsContainer.style.transform = 'translateY(-10px)';
            
            // Alerte g√©n√©rale
            const generalAlert = document.createElement('div');
            generalAlert.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm mb-3';
            generalAlert.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0 mt-0.5">üíô</div>
                    <div class="ml-3 flex-1">
                        <h3 class="font-medium text-blue-800">Nous avons d√©tect√© du contenu sensible</h3>
                        <p class="text-blue-700 mt-1 text-xs">
                            Votre bien-√™tre est important. Voici des ressources qui peuvent vous aider
                        </p>
                    </div>
                </div>
            `;
            alertsContainer.appendChild(generalAlert);
            
            // Alertes sp√©cifiques
            warnings.forEach((warning, index) => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm mb-2';
                alertDiv.style.animationDelay = `${index * 100}ms`;
                alertDiv.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mt-0.5">‚ö†Ô∏è</div>
                        <div class="ml-3 flex-1">
                            <p class="text-yellow-800 text-xs leading-relaxed">
                                ${warning.message}
                                ${warning.link ? `<br><a href="${warning.link}" target="_blank" class="underline text-yellow-900 hover:text-yellow-700 text-xs mt-1 inline-block">Plus d'informations</a>` : ''}
                            </p>
                        </div>
                    </div>
                `;
                alertsContainer.appendChild(alertDiv);
            });
            
            // Message de soutien
            const supportMessage = document.createElement('div');
            supportMessage.className = 'bg-green-50 border border-green-200 rounded-lg p-3 text-sm mt-3';
            supportMessage.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0 mt-0.5">ü§ù</div>
                    <div class="ml-3">
                        <p class="text-green-800 text-xs">
                            <strong>Vous n'√™tes pas seul(e).</strong> Demander de l'aide est un signe de force.
                        </p>
                    </div>
                </div>
            `;
            alertsContainer.appendChild(supportMessage);
            
            // Animation
            setTimeout(() => {
                alertsContainer.style.opacity = '1';
                alertsContainer.style.transform = 'translateY(0)';
                alertsContainer.style.transition = 'all 0.3s ease-in-out';
            }, 50);
        }
        
        // D√©tection intelligente avec debounce
        let monitoringTimeout;
        function monitorContent() {
            clearTimeout(monitoringTimeout);
            monitoringTimeout = setTimeout(() => {
                const title = titInput ? titInput.value : '';
                const description = descInput ? descInput.value : '';
                const fullText = (title + ' ' + description).trim();
                
                const warnings = checkSensitiveContent(fullText);
                displayAlerts(warnings);
            }, 300); // D√©lai de 300ms pour √©viter les traitements trop fr√©quents
        }
        
        // √âcouteurs d'√©v√©nements
        if (descInput) {
            descInput.addEventListener('input', monitorContent);
            descInput.addEventListener('paste', monitorContent);
        }
        
        if (titInput) {
            titInput.addEventListener('input', monitorContent);
            titInput.addEventListener('paste', monitorContent);
        }
        
        // V√©rification initiale
        monitorContent();
    }

    window.openPostCreateModal = openPostCreateModal;
    window.closePostCreateModal = closePostCreateModal;
</script>
{% endif %}
