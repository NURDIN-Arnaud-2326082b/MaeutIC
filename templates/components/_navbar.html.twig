{# filepath: c:\Users\Utilisateur\Documents\GitHub\MaeutIC\templates\components\_navbar.html.twig #}
<nav class="sticky top-0 bg-white shadow-lg shadow-black/5" style="isolation: isolate; z-index: 2147483647; pointer-events: auto;">
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4 h-20">
        <!-- div aligned to the left -->
        <div class="flex-shrink-0 h-full">
            <a href="{{ path('app_home') }}"><img src="{{ asset('images/logo.png') }}" alt="logo" class="h-full"/></a>
        </div>
        
        <!-- Div aligned to the right -->
        <div class="flex items-center space-x-4 ml-auto">
            {% if is_granted('IS_AUTHENTICATED_FULLY') %}
                {# Notifications bell (badge server-side via notificationsCount) #}
                <div class="relative mr-3">
                    <button id="notifButton" class="focus:outline-none" aria-label="Notifications" title="Notifications" type="button">
                        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>
                    </button>
                    <span id="notifBadge"
                          class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1 {{ (notificationsCount is defined and notificationsCount > 0) ? '' : 'hidden' }}">
                        {{ notificationsCount|default(0) }}
                    </span>

                    <div id="notifDropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl z-[10000] border border-gray-200">
                        <div id="notifItems" class="max-h-64 overflow-auto p-2">
                            <div class="text-sm text-gray-500 p-2">Chargement...</div>
                        </div>
                    </div>
                </div>

                {# Profile avatar + dropdown #}
                <div class="relative flex items-center">
                    <button id="profileDropdownButton" class="focus:outline-none" type="button" aria-haspopup="true" aria-expanded="false">
                        <img src="{% if app.user.profileImage %}{{ asset('profile_images/' ~ app.user.profileImage) }}{% else %}{{ asset('images/default-profile.png') }}{% endif %}" alt="Profil" class="w-10 h-10 rounded-full">
                    </button>
                    <div id="profileDropdownMenu" class="hidden absolute top-full mt-2 w-48 bg-white rounded-lg shadow-xl z-[10000] border border-gray-200">
                        <a href="{{ path('app_profile') }}" class="block px-4 py-2 text-black hover:bg-gray-100">Mon Profil</a>
                        <a href="{{ path('app_settings') }}" class="block px-4 py-2 text-black hover:bg-gray-100">Paramètres</a>
                        <a href="{{ path('app_logout') }}" class="block px-4 py-2 text-black hover:bg-gray-100">Se Déconnecter</a>
                    </div>
                </div>
            {% else %}
                <button type="button" onclick="window.location.href='{{ path('app_login') }}'"
                        class="text-gray-700 hover:text-blue-600 font-medium">
                    Se connecter
                </button>
                <button type="button" onclick="window.location.href='{{ path('app_register') }}'"
                        class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-2 focus:ring-indigo-500 font-medium rounded-lg text-sm px-5 py-2.5 focus:outline-none">
                    S'inscrire
                </button>
            {% endif %}
        </div>
    </div>
</nav>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Profile dropdown
    const dropdownButton = document.getElementById('profileDropdownButton');
    const dropdownMenu = document.getElementById('profileDropdownMenu');
    const notifButton = document.getElementById('notifButton');
    const notifDropdown = document.getElementById('notifDropdown');
    let portal = document.getElementById('dropdowns-portal');

    // Ensure a global portal exists at the end of <body> to host all floating dropdowns.
    // This avoids stacking/context issues (modals, other components) by centralizing z-index control.
    if (!portal) {
        portal = document.createElement('div');
        portal.id = 'dropdowns-portal';
        // portal covers viewport but pointer-events disabled so underlying clicks still work
        portal.style.position = 'fixed';
        portal.style.top = '0';
        portal.style.left = '0';
        portal.style.width = '100%';
        portal.style.height = '100%';
        portal.style.pointerEvents = 'none';
        // Keep portal at the same plane as the navbar so dropdowns appear visually flush.
        // Navbar uses z-index: 2147483647 — on many browsers equal z-index + DOM order
        // will keep appearance consistent. Portal stays non-interactive (pointer-events:none)
        // while dropdowns themselves are interactive (pointer-events:auto).
        portal.style.zIndex = String(2147483647);
        document.body.appendChild(portal);
    }

    function moveDropdownToPortal(dropdown, button) {
        if (!dropdown || !button || !portal) return;

        // Déplacer le dropdown dans le portail s'il n'y est pas déjà
        if (!dropdown.parentNode.isSameNode(portal)) {
            portal.appendChild(dropdown);
            // force fixed positioning and make it interactable while keeping portal non-interactive
            dropdown.style.position = 'fixed';
            dropdown.style.pointerEvents = 'auto';
            // place dropdown at the same z-index as the navbar so it is on the same visual plane
            dropdown.style.zIndex = String(2147483647);
            // avoid transforms from parent affecting stacking; reset transform if any
            dropdown.style.transform = 'none';
            dropdown.style.willChange = 'top, right';
        }

        // Positionner le dropdown (calcul droit/bas pour coller au bouton)
        const updatePosition = () => {
            const rect = button.getBoundingClientRect();
            // slight offset to avoid overlapping the button border
            const top = Math.max(0, rect.bottom + 6);
            const right = Math.max(0, window.innerWidth - rect.right);
            dropdown.style.top = `${top}px`;
            dropdown.style.right = `${right}px`;
        };

        updatePosition();
        return updatePosition;
    }

    // Gestion du dropdown profil
    if (dropdownButton && dropdownMenu) {
        const updateProfilePosition = moveDropdownToPortal(dropdownMenu, dropdownButton);
        
        dropdownButton.addEventListener('click', () => {
            dropdownMenu.classList.toggle('hidden');
            if (updateProfilePosition) updateProfilePosition();
        });
        
        document.addEventListener('click', (event) => {
            if (!dropdownButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });
        
        window.addEventListener('resize', () => {
            if (updateProfilePosition) updateProfilePosition();
        });
    }

    // Gestion du dropdown notifications
    if (notifButton && notifDropdown) {
        const updateNotifPosition = moveDropdownToPortal(notifDropdown, notifButton);
        
        notifButton.addEventListener('click', (e) => {
            notifDropdown.classList.toggle('hidden');
            if (updateNotifPosition) updateNotifPosition();
            if (!notifDropdown.classList.contains('hidden')) {
                fetchNotifications();
            }
        });
        
        document.addEventListener('click', (e) => {
            if (!notifButton.contains(e.target) && !notifDropdown.contains(e.target)) {
                notifDropdown.classList.add('hidden');
            }
        });
        
        window.addEventListener('resize', () => {
            if (updateNotifPosition) updateNotifPosition();
        });
    }

    // Notifications
    const notifBadge = document.getElementById('notifBadge');
    const notifItems = document.getElementById('notifItems');

    // template URL pour ouvrir le profil d'un utilisateur (___USERNAME___ sera remplacé)
    const profileUrlTemplate = '{{ path('app_profile_show', {'username':'___USERNAME___'}) }}';
    
    function renderNotificationItem(n) {
        const sender = (n.sender && n.sender.username) ? n.sender.username : 'Utilisateur';
        const div = document.createElement('div');
        div.className = 'p-2 border-b last:border-b-0';
        // Si c'est une demande de réseau, afficher Accept/Decline
        if (n.type === 'network_request') {
            const senderUsername = (n.sender && n.sender.username) ? n.sender.username : '';
            const target = senderUsername ? profileUrlTemplate.replace('___USERNAME___', encodeURIComponent(senderUsername)) : '#';
            div.innerHTML = `
                <div class="flex justify-between items-start notif-network" data-target="${target}" data-id="${n.id}">
                    <div class="text-sm">
                        <div class="font-semibold">${sender}</div>
                        <div class="text-xs text-gray-600">${(n.data && n.data.message) ? n.data.message : 'Demande de connexion'}</div>
                    </div>
                    <div class="flex space-x-1">
                        <button data-id="${n.id}" class="notif-accept bg-green-600 text-white text-xs px-2 py-1 rounded">Accepter</button>
                        <button data-id="${n.id}" class="notif-decline bg-gray-200 text-xs px-2 py-1 rounded">Refuser</button>
                    </div>
                </div>
            `;
            // cliquer sur la zone (hors boutons) ouvre le profil de l'expéditeur
            const networkEl = div.querySelector('.notif-network');
            if (networkEl) {
                networkEl.addEventListener('click', (e) => {
                    // si on a cliqué un des boutons, ne pas naviguer
                    if (e.target.closest('.notif-accept') || e.target.closest('.notif-decline')) return;
                    const tgt = networkEl.dataset.target;
                    if (tgt && tgt !== '#') {
                        window.location.href = tgt;
                    }
                });
            }
        } else {
            // Autres types : rendre l'élément cliquable pour accéder directement au post lié
            const message = (n.data && n.data.message) ? n.data.message : 'Vous avez une notification';
            const postId = n.data && n.data.postId ? n.data.postId : null;
            // construire un target minimal ; fallback vers General si manque d'infos
            const target = postId ? `/forums/General/${encodeURIComponent(postId)}` : '#';
            div.innerHTML = `
                <div class="flex justify-between items-start cursor-pointer notif-item-link" data-target="${target}" data-id="${n.id}">
                    <div class="text-sm">
                        <div class="font-semibold">${sender}</div>
                        <div class="text-xs text-gray-600">${message}</div>
                    </div>
                </div>
            `;
            // navigation au clic sur l'item + suppression de la notification (via decline endpoint)
            div.querySelector('.notif-item-link').addEventListener('click', async (e) => {
                e.preventDefault();
                const id = e.currentTarget.dataset.id;
                try {
                    // tenter de supprimer la notification côté serveur avant navigation
                    await fetch('/notifications/decline/' + encodeURIComponent(id), {
                        method: 'POST',
                        headers: {'X-Requested-With': 'XMLHttpRequest'},
                        credentials: 'same-origin'
                    });
                } catch (err) {
                    console.error('Failed to remove notification', err);
                    // on continue malgré l'erreur
                }
                if (target !== '#') {
                    window.location.href = target;
                } else {
                    // rafraîchir la liste si pas de cible
                    fetchNotifications();
                }
            });
        }
        return div;
    }

    async function fetchNotifications() {
        if (!notifItems) return;
        try {
            // fallback si la variable notificationsUrl n'est pas fournie par le controller
            const notificationsUrl = '{{ notificationsUrl|default('/notifications') }}';
            const res = await fetch(notificationsUrl, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'same-origin' // permet d'envoyer le cookie de session
            });
            if (!res.ok) throw new Error('network');
            const json = await res.json();
            const arr = json.notifications || [];

            if (notifBadge) {
                if (arr.length > 0) {
                    notifBadge.textContent = arr.length;
                    notifBadge.classList.remove('hidden');
                } else {
                    notifBadge.classList.add('hidden');
                }
            }

            notifItems.innerHTML = '';
            if (arr.length === 0) {
                notifItems.innerHTML = '<div class="text-sm text-gray-500 p-2">Aucune notification.</div>';
            } else {
                arr.forEach(n => notifItems.appendChild(renderNotificationItem(n)));

                // Ajouter footer "Tout effacer"
                const footer = document.createElement('div');
                footer.className = 'p-2 border-t text-center';
                footer.innerHTML = `<button id="clearAllNotifs" class="text-xs text-red-600 hover:underline">Tout effacer</button>`;
                notifItems.appendChild(footer);

                // wiring clear all
                const clearBtn = document.getElementById('clearAllNotifs');
                if (clearBtn) {
                    clearBtn.onclick = async () => {
                        clearBtn.disabled = true;
                        try {
                            const r = await fetch('/notifications/clear-all', {
                                method: 'POST',
                                headers: {'X-Requested-With': 'XMLHttpRequest'},
                                credentials: 'same-origin'
                            });
                            if (!r.ok) throw new Error('clear failed');
                        } catch (err) {
                            console.error(err);
                        } finally {
                            // rafraîchir la liste
                            fetchNotifications();
                        }
                    };
                }
            }

            // Wire buttons
            // Accept/Decline n'existent que pour les network_request : on branche seulement si présents
            document.querySelectorAll('.notif-accept').forEach(btn => {
                 btn.onclick = async (e) => {
                     const id = e.currentTarget.dataset.id;
                     e.currentTarget.disabled = true;
                     try {
                         const r = await fetch('/notifications/accept/' + encodeURIComponent(id), {
                             method: 'POST',
                             headers: {'X-Requested-With': 'XMLHttpRequest'},
                             credentials: 'same-origin'
                         });
                         const j = await r.json();
                         if (j.success) {
                             // rafraîchir la liste
                         }
                     } catch (err) {
                         console.error(err);
                     } finally {
                         fetchNotifications();
                     }
                 };
             });

             document.querySelectorAll('.notif-decline').forEach(btn => {
                 btn.onclick = async (e) => {
                     const id = e.currentTarget.dataset.id;
                     e.currentTarget.disabled = true;
                     try {
                         await fetch('/notifications/decline/' + encodeURIComponent(id), {
                             method: 'POST',
                             headers: {'X-Requested-With': 'XMLHttpRequest'},
                             credentials: 'same-origin'
                         });
                     } catch (err) {
                         console.error(err);
                     } finally {
                         fetchNotifications();
                     }
                 };
             });
        } catch (err) {
            console.error('Failed to fetch notifications', err);
        }
    }

    // Poll every 15s
    setInterval(fetchNotifications, 15000);
});
</script>