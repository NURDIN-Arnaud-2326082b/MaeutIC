<div class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-100 mb-6" style="position: relative; z-index: 40;">
    <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6">
        <!-- Partie gauche : Barres de recherche -->
        <div class="flex-1 w-full lg:w-auto">
            <div class="flex flex-row gap-6">
                <!-- Recherche par nom -->
                <div class="flex-1">
                    <input 
                        type="text" 
                        id="user-search" 
                        placeholder="Rechercher par pseudo, nom, prénom, location, spécialisation, sujet de recherche..." 
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50/50 transition-all duration-200"
                    >
                </div>
                
                <!-- Recherche par tags -->
                <div class="flex-1 relative" style="z-index: 100;">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="tag-search-input" 
                            placeholder="Rechercher un mot-clé..." 
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50/50 transition-all duration-200"
                            autocomplete="off"
                        >
                        <div id="tag-suggestions" class="absolute left-0 right-0 top-full mt-2 bg-white border border-gray-200 rounded-xl shadow-2xl z-[9999] max-h-60 overflow-y-auto hidden" style="position: absolute; z-index: 9999;"></div>
                    </div>
                    <div id="active-tags" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Partie droite : Filtres par type -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
            <div class="flex items-center gap-20 bg-gray-50/50 rounded-xl p-4 border border-gray-200">
                <label class="flex flex-col gap-1 cursor-pointer group px-4" id="friends-label">
                    <div class="flex items-center gap-3">
                        <input 
                            type="checkbox" 
                            id="filter-friends" 
                            class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2 transition-all duration-200"
                            checked
                            onchange="updateUserMapFilters()"
                        >
                        <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 transition-colors">Réseau</span>
                    </div>
                </label>
                
                <div class="h-8 w-px bg-gray-300/50"></div>
                
                <label class="flex flex-col gap-1 cursor-pointer group px-4" id="recommendations-label">
                    <div class="flex items-center gap-3">
                        <input 
                            type="checkbox" 
                            id="filter-recommendations" 
                            class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2 transition-all duration-200"
                            checked
                            onchange="updateUserMapFilters()"
                        >
                        <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 transition-colors">Recommandations</span>
                    </div>
                </label>
            </div>
        </div>
    </div>

    <!-- Pagination pour les résultats de recherche utilisateur -->
    <div id="user-search-pagination" class="hidden mt-4">
        <div class="flex items-center justify-between bg-green-50/50 rounded-xl p-3 border border-green-200">
            <span id="user-search-results-info" class="text-sm text-green-700 font-medium"></span>
            <div class="flex items-center gap-2">
                <button id="prev-user-page" class="px-3 py-1 text-sm bg-white border border-green-300 rounded-lg text-green-700 hover:bg-green-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Précédent
                </button>
                <span id="user-page-info" class="text-sm text-green-700 mx-2"></span>
                <button id="next-user-page" class="px-3 py-1 text-sm bg-white border border-green-300 rounded-lg text-green-700 hover:bg-green-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Suivant
                </button>
                <button id="clear-user-search" class="px-3 py-1 text-sm bg-red-100 border border-red-300 rounded-lg text-red-700 hover:bg-red-200 ml-2">
                    Effacer
                </button>
            </div>
        </div>
    </div>

    <!-- Pagination pour les résultats de tags -->
    <div id="tag-results-pagination" class="hidden mt-4">
        <div class="flex items-center justify-between bg-blue-50/50 rounded-xl p-3 border border-blue-200">
            <span id="tag-results-info" class="text-sm text-blue-700 font-medium"></span>
            <div class="flex items-center gap-2">
                <button id="prev-tag-page" class="px-3 py-1 text-sm bg-white border border-blue-300 rounded-lg text-blue-700 hover:bg-blue-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Précédent
                </button>
                <span id="tag-page-info" class="text-sm text-blue-700 mx-2"></span>
                <button id="next-tag-page" class="px-3 py-1 text-sm bg-white border border-blue-300 rounded-lg text-blue-700 hover:bg-blue-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Suivant
                </button>
                <button id="clear-tag-search" class="px-3 py-1 text-sm bg-red-100 border border-red-300 rounded-lg text-red-700 hover:bg-red-200 ml-2">
                    Effacer
                </button>
            </div>
        </div>
    </div>

    <!-- État de chargement -->
    <div id="filter-loading" class="hidden mt-4">
        <div class="flex items-center justify-center gap-2 text-blue-600">
            <div class="animate-spin h-5 w-5 border-2 border-blue-600 border-t-transparent rounded-full"></div>
            <span class="text-sm font-medium">Mise à jour de la carte...</span>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables pour la recherche par tags
    let selectedTags = [];
    let currentTagPage = 1;
    const TAGS_PER_PAGE = 20;

    // Variables pour la recherche utilisateur
    let currentUserPage = 1;
    const USERS_PER_PAGE = 20;
    let currentSearchQuery = '';

    // Récupérer les éléments DOM pour les tags
    const tagSearchInput = document.getElementById('tag-search-input');
    const tagSuggestions = document.getElementById('tag-suggestions');
    const activeTags = document.getElementById('active-tags');

    // Récupérer les éléments DOM pour la recherche utilisateur
    const userSearchInput = document.getElementById('user-search');
    const userSearchPagination = document.getElementById('user-search-pagination');
    const userSearchResultsInfo = document.getElementById('user-search-results-info');
    const userPageInfo = document.getElementById('user-page-info');
    const prevUserPage = document.getElementById('prev-user-page');
    const nextUserPage = document.getElementById('next-user-page');
    const clearUserSearch = document.getElementById('clear-user-search');

    // Vérifier si les éléments existent
    if (!tagSearchInput || !tagSuggestions || !activeTags) {
        console.error('Éléments DOM non trouvés pour la recherche de tags');
    }

    if (!userSearchInput || !userSearchPagination) {
        console.error('Éléments DOM non trouvés pour la recherche utilisateur');
    }

    // Fonction principale de filtrage
    function updateUserMapFilters() {
        if (currentSearchQuery.length > 0) {
            searchUsers();
            return;
        }
        
        if (selectedTags.length > 0) {
            searchUsersByTags();
            return;
        }

        const showFriends = document.getElementById('filter-friends').checked;
        const showRecommendations = document.getElementById('filter-recommendations').checked;
        
        const url = new URL(window.location);
        url.searchParams.set('friends', showFriends);
        url.searchParams.set('recommendations', showRecommendations);
        window.history.replaceState({}, '', url);
        
        performFilterRequest(`/maps/filter-by-type?friends=${showFriends}&recommendations=${showRecommendations}`);
    }

    // Fonction de recherche par tags
    function searchUsersByTags() {
        const showFriends = document.getElementById('filter-friends').checked;
        const showRecommendations = document.getElementById('filter-recommendations').checked;
        
        const tagIds = selectedTags.map(tag => tag.id);
        const params = new URLSearchParams();
        tagIds.forEach(id => params.append('tags[]', id));
        params.append('friends', showFriends);
        params.append('recommendations', showRecommendations);
        params.append('page', currentTagPage);
        params.append('limit', TAGS_PER_PAGE);
        
        performFilterRequest(`/maps/filter-by-tags?${params.toString()}`);
    }

    // Fonction de recherche utilisateur
    function searchUsers() {
        const query = userSearchInput.value.trim();
        currentSearchQuery = query;
        
        if (query.length === 0) {
            clearUserSearchResults();
            return;
        }
        
        const showFriends = document.getElementById('filter-friends').checked;
        const showRecommendations = document.getElementById('filter-recommendations').checked;
        
        const params = new URLSearchParams();
        params.append('q', query);
        params.append('friends', showFriends);
        params.append('recommendations', showRecommendations);
        params.append('page', currentUserPage);
        params.append('limit', USERS_PER_PAGE);
        
        performFilterRequest(`/maps/search-users?${params.toString()}`);
    }

    // Fonction pour effectuer les requêtes de filtrage
    function performFilterRequest(url) {
        const loadingIndicator = document.getElementById('filter-loading');
        const container = document.getElementById('bubble-container');
        const originalContent = container.innerHTML;
        
        loadingIndicator.classList.remove('hidden');
        container.style.opacity = '0.7';
        container.style.transform = 'scale(0.98)';
        container.style.transition = 'all 0.3s ease';
        
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur réseau: ' + response.status);
            }
            return response.text();
        })
        .then(html => {
            container.innerHTML = html;
            
            setTimeout(() => {
                loadingIndicator.classList.add('hidden');
                container.style.opacity = '1';
                container.style.transform = 'scale(1)';
                
                if (window.renderUserBubbles) {
                    window.renderUserBubbles();
                }
            }, 300);
        })
        .catch(error => {
            console.error('Erreur lors du filtrage:', error);
            container.innerHTML = originalContent;
            loadingIndicator.classList.add('hidden');
            container.style.opacity = '1';
            container.style.transform = 'scale(1)';
            
            showNotification('Erreur lors du filtrage des utilisateurs', 'error');
        });
    }

    // Fonction pour effacer les résultats de recherche utilisateur
    function clearUserSearchResults() {
        currentSearchQuery = '';
        currentUserPage = 1;
        if (userSearchPagination) {
            userSearchPagination.classList.add('hidden');
        }
        updateUserMapFilters();
    }

    // Fonction pour mettre à jour la pagination utilisateur
    function updateUserSearchPagination(totalUsers, totalPages) {
        if (!userSearchPagination || currentSearchQuery.length === 0) {
            if (userSearchPagination) userSearchPagination.classList.add('hidden');
            return;
        }
        
        userSearchPagination.classList.remove('hidden');
        if (userSearchResultsInfo) {
            userSearchResultsInfo.textContent = `${totalUsers} utilisateurs trouvés pour "${currentSearchQuery}"`;
        }
        if (userPageInfo) {
            userPageInfo.textContent = `Page ${currentUserPage} sur ${totalPages}`;
        }
        
        if (prevUserPage) prevUserPage.disabled = currentUserPage <= 1;
        if (nextUserPage) nextUserPage.disabled = currentUserPage >= totalPages;
        
        if (prevUserPage) {
            prevUserPage.onclick = () => {
                if (currentUserPage > 1) {
                    currentUserPage--;
                    searchUsers();
                }
            };
        }
        
        if (nextUserPage) {
            nextUserPage.onclick = () => {
                if (currentUserPage < totalPages) {
                    currentUserPage++;
                    searchUsers();
                }
            };
        }
        
        if (clearUserSearch) {
            clearUserSearch.onclick = () => {
                userSearchInput.value = '';
                clearUserSearchResults();
            };
        }
    }

    // Fonctions pour la recherche par tags
    function debounce(fn, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    function fetchTagSuggestions(query) {
        console.log('Recherche de tags avec:', query);
        fetch('/tag/search?q=' + encodeURIComponent(query))
            .then(r => {
                if (!r.ok) {
                    throw new Error('Erreur réseau: ' + r.status);
                }
                return r.json();
            })
            .then(tags => {
                console.log('Tags reçus:', tags);
                if (!tagSuggestions) return;
                
                tagSuggestions.innerHTML = '';
                
                if (tags.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'px-4 py-2 text-gray-500 text-sm';
                    noResults.textContent = 'Aucun tag trouvé';
                    tagSuggestions.appendChild(noResults);
                } else {
                    tags.forEach(tag => {
                        if (selectedTags.find(t => t.id === tag.id)) return;
                        const div = document.createElement('div');
                        div.className = 'px-4 py-2 hover:bg-blue-100 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors duration-150';
                        div.textContent = tag.name;
                        div.dataset.tagId = tag.id;
                        div.dataset.tagName = tag.name;
                        div.onclick = () => {
                            addActiveTag(tag.id, tag.name);
                            tagSuggestions.innerHTML = '';
                            tagSuggestions.classList.add('hidden');
                            tagSearchInput.value = '';
                        };
                        tagSuggestions.appendChild(div);
                    });
                }
                tagSuggestions.classList.remove('hidden');
                
                setTimeout(() => {
                    tagSuggestions.style.zIndex = '9999';
                }, 10);
            })
            .catch(error => {
                console.error('Erreur lors de la recherche de tags:', error);
                if (!tagSuggestions) return;
                
                tagSuggestions.innerHTML = '';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'px-4 py-2 text-red-500 text-sm';
                errorDiv.textContent = 'Erreur lors de la recherche';
                tagSuggestions.appendChild(errorDiv);
                tagSuggestions.classList.remove('hidden');
                
                setTimeout(() => {
                    tagSuggestions.style.zIndex = '9999';
                }, 10);
            });
    }

    function addActiveTag(id, name) {
        if (selectedTags.find(t => t.id == id)) return;
        selectedTags.push({id, name});
        renderActiveTags();
        
        disableTypeFilters();
        
        currentTagPage = 1;
        searchUsersByTags();
    }

    function removeActiveTag(id) {
        selectedTags = selectedTags.filter(t => t.id != id);
        renderActiveTags();
        
        if (selectedTags.length === 0) {
            enableTypeFilters();
            updateUserMapFilters();
            if (document.getElementById('tag-results-pagination')) {
                document.getElementById('tag-results-pagination').classList.add('hidden');
            }
        } else {
            currentTagPage = 1;
            searchUsersByTags();
        }
    }

    function renderActiveTags() {
        if (!activeTags) return;
        
        activeTags.innerHTML = '';
        selectedTags.forEach(tag => {
            const span = document.createElement('span');
            span.className = 'bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full flex items-center gap-1';
            span.innerHTML = `
                ${tag.name}
                <button type="button" class="remove-tag text-indigo-600 font-bold hover:text-red-500 transition-colors" data-tag-id="${tag.id}">&times;</button>
            `;
            span.querySelector('.remove-tag').onclick = () => removeActiveTag(tag.id);
            activeTags.appendChild(span);
        });
    }

    function disableTypeFilters() {
        const friendsCheckbox = document.getElementById('filter-friends');
        const recommendationsCheckbox = document.getElementById('filter-recommendations');
        const friendsLabel = document.getElementById('friends-label');
        const recommendationsLabel = document.getElementById('recommendations-label');
        
        if (friendsCheckbox) friendsCheckbox.disabled = true;
        if (recommendationsCheckbox) recommendationsCheckbox.disabled = true;
        if (friendsLabel) friendsLabel.classList.add('opacity-50', 'cursor-not-allowed');
        if (recommendationsLabel) recommendationsLabel.classList.add('opacity-50', 'cursor-not-allowed');
    }

    function enableTypeFilters() {
        const friendsCheckbox = document.getElementById('filter-friends');
        const recommendationsCheckbox = document.getElementById('filter-recommendations');
        const friendsLabel = document.getElementById('friends-label');
        const recommendationsLabel = document.getElementById('recommendations-label');
        
        if (friendsCheckbox) friendsCheckbox.disabled = false;
        if (recommendationsCheckbox) recommendationsCheckbox.disabled = false;
        if (friendsLabel) friendsLabel.classList.remove('opacity-50', 'cursor-not-allowed');
        if (recommendationsLabel) recommendationsLabel.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    function updateTagPagination(totalUsers, totalPages) {
        const pagination = document.getElementById('tag-results-pagination');
        const resultsInfo = document.getElementById('tag-results-info');
        const pageInfo = document.getElementById('tag-page-info');
        const prevButton = document.getElementById('prev-tag-page');
        const nextButton = document.getElementById('next-tag-page');
        
        if (selectedTags.length === 0) {
            if (pagination) pagination.classList.add('hidden');
            return;
        }
        
        if (pagination) pagination.classList.remove('hidden');
        if (resultsInfo) resultsInfo.textContent = `${totalUsers} utilisateurs trouvés avec les tags sélectionnés`;
        if (pageInfo) pageInfo.textContent = `Page ${currentTagPage} sur ${totalPages}`;
        
        if (prevButton) prevButton.disabled = currentTagPage <= 1;
        if (nextButton) nextButton.disabled = currentTagPage >= totalPages;
        
        if (prevButton) {
            prevButton.onclick = () => {
                if (currentTagPage > 1) {
                    currentTagPage--;
                    searchUsersByTags();
                }
            };
        }
        
        if (nextButton) {
            nextButton.onclick = () => {
                if (currentTagPage < totalPages) {
                    currentTagPage++;
                    searchUsersByTags();
                }
            };
        }
        
        const clearButton = document.getElementById('clear-tag-search');
        if (clearButton) {
            clearButton.onclick = () => {
                selectedTags = [];
                renderActiveTags();
                enableTypeFilters();
                if (pagination) pagination.classList.add('hidden');
                updateUserMapFilters();
            };
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        const bgColor = type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Événements de recherche par tags
    if (tagSearchInput) {
        tagSearchInput.addEventListener('input', debounce(function() {
            const query = this.value.trim();
            console.log('Input event:', query);
            if (query.length >= 2) {
                fetchTagSuggestions(query);
            } else {
                if (tagSuggestions) tagSuggestions.classList.add('hidden');
            }
        }, 200));

        tagSearchInput.addEventListener('focus', function() {
            const query = this.value.trim();
            console.log('Focus event:', query);
            if (query.length >= 2) {
                fetchTagSuggestions(query);
            }
        });
    }

    // Événements de recherche utilisateur
    if (userSearchInput) {
        userSearchInput.addEventListener('input', debounce(function() {
            currentUserPage = 1;
            searchUsers();
        }, 300));
    }

    // Fermeture des suggestions en cliquant ailleurs
    document.addEventListener('click', function(e) {
        if (tagSearchInput && tagSuggestions && !tagSearchInput.contains(e.target) && !tagSuggestions.contains(e.target)) {
            tagSuggestions.classList.add('hidden');
        }
    });

    // Initialiser les filtres
    const urlParams = new URLSearchParams(window.location.search);
    const friendsParam = urlParams.get('friends');
    const recommendationsParam = urlParams.get('recommendations');
    
    if (friendsParam !== null) {
        const friendsCheckbox = document.getElementById('filter-friends');
        if (friendsCheckbox) friendsCheckbox.checked = friendsParam === 'true';
    }
    if (recommendationsParam !== null) {
        const recommendationsCheckbox = document.getElementById('filter-recommendations');
        if (recommendationsCheckbox) recommendationsCheckbox.checked = recommendationsParam === 'true';
    }

    // Gérer la pagination au chargement
    const totalUsers = {{ app.request.headers.get('X-Total-Users') ?? 0 }};
    const totalPages = {{ app.request.headers.get('X-Total-Pages') ?? 1 }};
    const currentPage = {{ app.request.headers.get('X-Current-Page') ?? 1 }};
    
    const searchQuery = urlParams.get('q');
    
    if (searchQuery && window.updateUserSearchPagination) {
        currentSearchQuery = searchQuery;
        if (userSearchInput) userSearchInput.value = searchQuery;
        window.updateUserSearchPagination(totalUsers, totalPages);
    } else if (totalUsers > 0 && window.updateTagPagination) {
        window.updateTagPagination(totalUsers, totalPages);
    }

    // Exposer les fonctions globalement
    window.updateTagPagination = updateTagPagination;
    window.updateUserSearchPagination = updateUserSearchPagination;
    window.updateUserMapFilters = updateUserMapFilters;

    console.log('Système de recherche initialisé');
});
</script>