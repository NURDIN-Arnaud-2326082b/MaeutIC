name: Déploiement sur IONOS via FTP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      IONOS_HOST: ${{ secrets.IONOS_HOST }}
      IONOS_USER: ${{ secrets.IONOS_USER }}
      IONOS_PASSWORD: ${{ secrets.IONOS_PASSWORD }}
      IONOS_PATH: ${{ secrets.IONOS_PATH }}

    steps:
      - name: Cloner le dépôt
        uses: actions/checkout@v3

      - name: Build frontend (runner) — only if package.json exists
        if: fileExists('package.json')  # note: this expression works only with a JS action; fallback below uses a run-check
        uses: actions/setup-node@v3
        with:
          node-version: '16'
      - name: Build frontend (runner) — fallback run-check
        run: |
          if [ -f package.json ]; then
            echo "package.json found — building frontend"
            npm ci
            if npm run | grep -q 'build'; then
              npm run build || true
            else
              echo "No npm build script, skipping."
            fi
          else
            echo "No package.json — skipping frontend build."
          fi

      - name: Afficher les fichiers avant déploiement
        run: |
          ls -R ./src || true
          ls -R ./public || true
          if [ -f composer.json ]; then cat composer.json; fi

      - name: Vérifier IONOS_PATH côté runner (ne révèle pas la valeur)
        run: |
          if [ -z "${{ env.IONOS_PATH }}" ]; then
            echo "ERROR: IONOS_PATH est vide. Ajoutez le secret 'IONOS_PATH' dans Settings → Secrets." >&2
            exit 1
          else
            echo "IONOS_PATH est défini sur le runner (longueur: $(echo -n '${{ env.IONOS_PATH }}' | wc -c) octets)."
          fi

      - name: Préparer le dossier distant (création + vérification)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.IONOS_HOST }}
          username: ${{ env.IONOS_USER }}
          password: ${{ env.IONOS_PASSWORD }}
          port: 22
          script: |
            IONOS_PATH='${{ env.IONOS_PATH }}'
            echo "Target path: $IONOS_PATH"
            mkdir -p "$IONOS_PATH"
            chmod 755 "$IONOS_PATH" || true
            echo "Parent and target listing:"
            ls -la "$(dirname "$IONOS_PATH")" || true
            ls -la "$IONOS_PATH" || true

      - name: Déployer via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.IONOS_HOST }}
          username: ${{ env.IONOS_USER }}
          password: ${{ env.IONOS_PASSWORD }}
          port: 22
          source: "src/**,public/**,composer.json"
          target: ${{ env.IONOS_PATH }}

      - name: Exécuter des commandes sur IONOS (optimisations post-déploiement)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.IONOS_HOST }}
          username: ${{ env.IONOS_USER }}
          password: ${{ env.IONOS_PASSWORD }}
          port: 22
          script: |
            IONOS_PATH='${{ env.IONOS_PATH }}'
            PROJECT_ROOT="$(dirname "$IONOS_PATH")"
            echo "Project root: $PROJECT_ROOT"
            # Composer: installer / optimiser l'autoload si composer.json présent
            if ssh -V >/dev/null 2>&1; then :; fi
            if [ -f "$PROJECT_ROOT/composer.json" ]; then
              cd "$PROJECT_ROOT"
              # utiliser composer présent sur le serveur si possible
              if command -v composer >/dev/null 2>&1; then
                composer install --no-dev --optimize-autoloader --no-interaction || true
                composer dump-autoload --optimize || true
              else
                echo "composer not found on remote — skipped composer install/dump-autoload"
              fi
            else
              echo "No composer.json in $PROJECT_ROOT, skipping composer steps."
            fi

            # Permissions: rendre web-readable (éviter chmod récursif dangereux)
            if [ -d "$PROJECT_ROOT/public" ]; then
              chmod -R u=rwX,g=rX,o=rX "$PROJECT_ROOT/public" || true
            fi
            # Si projet Laravel, fixer storage & cache, et mettre en cache config/routes si possible
            if [ -f "$PROJECT_ROOT/artisan" ]; then
              if command -v php >/dev/null 2>&1; then
                php "$PROJECT_ROOT/artisan" storage:link || true
                chmod -R ug+rwx "$PROJECT_ROOT/storage" "$PROJECT_ROOT/bootstrap/cache" || true
                php "$PROJECT_ROOT/artisan" config:cache || true
                php "$PROJECT_ROOT/artisan" route:cache || true
              else
                echo "php not available on remote — cannot run artisan commands"
              fi
            fi
            # nettoyage de fichiers temporaires éventuels
            rm -f "$PROJECT_ROOT"/*.tar.gz || true

      - name: Vérifier les fichiers déployés (remote)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.IONOS_HOST }}
          username: ${{ env.IONOS_USER }}
          password: ${{ env.IONOS_PASSWORD }}
          port: 22
          script: |
            IONOS_PATH='${{ env.IONOS_PATH }}'
            PROJECT_ROOT="$(dirname "$IONOS_PATH")"
            echo "Check index in public folder:"
            if [ -f "$IONOS_PATH/index.php" ]; then
              echo "index.php exists — showing first 20 lines:"
              sed -n '1,20p' "$IONOS_PATH/index.php" || true
            else
              echo "No index.php in $IONOS_PATH. List public folder:"
              ls -la "$IONOS_PATH" || true
            fi
